openapi: 3.0.3
info:
  title: Publier API
  version: 1.0.0
  description: |
    Publier is a developer-first content orchestration platform.

    ## Authentication

    Publier uses two authentication mechanisms:

    - **Session tokens** (`pub_session_*`) — For account management (register, login, apps, keys)
    - **API keys** (`pub_live_*`, `pub_test_*`) — For programmatic API access (posts, analytics)

    ## Rate Limiting

    All authenticated endpoints are rate-limited to 100 requests per minute per API key.
    Rate limit headers are included in all responses.

    ## Idempotency

    Write operations support idempotency via the `Idempotency-Key` header.

  contact:
    name: Pranay Patel
  license:
    name: ISC

servers:
  - url: http://localhost:3000
    description: Local development

tags:
  - name: Health
    description: System health checks
  - name: Auth
    description: Developer account authentication
  - name: Apps
    description: Developer application management
  - name: API Keys
    description: API key management
  - name: Posts
    description: Content creation and management

paths:
  /v1/health:
    get:
      tags: [Health]
      summary: Health check
      description: Returns the health status of the API and its dependencies.
      operationId: getHealth
      security: []
      responses:
        "200":
          description: All systems healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
        "503":
          description: One or more dependencies unhealthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

  /v1/auth/register:
    post:
      tags: [Auth]
      summary: Register a new developer account
      operationId: register
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterRequest"
      responses:
        "201":
          description: Account created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "400":
          $ref: "#/components/responses/BadRequest"
        "409":
          $ref: "#/components/responses/Conflict"

  /v1/auth/login:
    post:
      tags: [Auth]
      summary: Login and receive a session token
      operationId: login
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /v1/auth/logout:
    post:
      tags: [Auth]
      summary: End the current session
      operationId: logout
      security:
        - sessionAuth: []
      responses:
        "200":
          description: Logged out successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Successfully logged out
        "401":
          $ref: "#/components/responses/Unauthorized"

  /v1/auth/me:
    get:
      tags: [Auth]
      summary: Get current user info
      operationId: getCurrentUser
      security:
        - sessionAuth: []
      responses:
        "200":
          description: Current user info
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /v1/auth/verify-email:
    get:
      tags: [Auth]
      summary: Verify email address
      description: Verifies the user's email address using a token sent via email.
      operationId: verifyEmail
      parameters:
        - name: token
          in: query
          required: true
          schema:
            type: string
          description: Email verification token (evt_...)
      responses:
        "200":
          description: Email verified successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Email verified successfully
                  user_id:
                    type: string
                    format: uuid
        "400":
          $ref: "#/components/responses/BadRequest"

  /v1/auth/resend-verification:
    post:
      tags: [Auth]
      summary: Resend verification email
      description: Sends a new verification email to the authenticated user.
      operationId: resendVerificationEmail
      security:
        - sessionAuth: []
      responses:
        "200":
          description: Verification email sent
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Verification email sent successfully
        "400":
          description: Email already verified
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /v1/apps:
    post:
      tags: [Apps]
      summary: Create a new app
      operationId: createApp
      security:
        - sessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateAppRequest"
      responses:
        "201":
          description: App created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/App"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "409":
          $ref: "#/components/responses/Conflict"

    get:
      tags: [Apps]
      summary: List all apps
      operationId: listApps
      security:
        - sessionAuth: []
      responses:
        "200":
          description: List of apps
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/App"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /v1/apps/{appId}:
    parameters:
      - $ref: "#/components/parameters/appId"

    get:
      tags: [Apps]
      summary: Get app details
      operationId: getApp
      security:
        - sessionAuth: []
      responses:
        "200":
          description: App details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/App"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

    patch:
      tags: [Apps]
      summary: Update app
      operationId: updateApp
      security:
        - sessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateAppRequest"
      responses:
        "200":
          description: App updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/App"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

    delete:
      tags: [Apps]
      summary: Delete app
      description: Deleting an app also deletes all its API keys.
      operationId: deleteApp
      security:
        - sessionAuth: []
      responses:
        "204":
          description: App deleted
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /v1/apps/{appId}/keys:
    parameters:
      - $ref: "#/components/parameters/appId"

    post:
      tags: [API Keys]
      summary: Generate a new API key
      description: |
        Creates a new API key for the app. The raw key is returned only once
        in this response — store it securely.
      operationId: createApiKey
      security:
        - sessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateApiKeyRequest"
      responses:
        "201":
          description: API key created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiKeyCreated"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

    get:
      tags: [API Keys]
      summary: List API keys
      description: Returns all API keys for the app. Full keys are never returned.
      operationId: listApiKeys
      security:
        - sessionAuth: []
      responses:
        "200":
          description: List of API keys
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/ApiKey"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /v1/apps/{appId}/keys/{keyId}:
    parameters:
      - $ref: "#/components/parameters/appId"
      - $ref: "#/components/parameters/keyId"

    delete:
      tags: [API Keys]
      summary: Revoke an API key
      description: Immediately revokes the API key. Any requests using it will fail.
      operationId: revokeApiKey
      security:
        - sessionAuth: []
      responses:
        "204":
          description: API key revoked
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /v1/posts:
    post:
      tags: [Posts]
      summary: Create a post
      description: Creates a new post. Supports idempotency via `Idempotency-Key` header.
      operationId: createPost
      security:
        - apiKeyAuth: []
      parameters:
        - $ref: "#/components/parameters/idempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreatePostRequest"
      responses:
        "201":
          description: Post created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Post"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "429":
          $ref: "#/components/responses/RateLimited"

    get:
      tags: [Posts]
      summary: List posts
      operationId: listPosts
      security:
        - apiKeyAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: status
          in: query
          schema:
            type: string
            enum: [draft, scheduled, published, failed]
        - name: order
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: desc
        - name: cursor
          in: query
          description: ISO 8601 timestamp for cursor-based pagination
          schema:
            type: string
            format: date-time
      responses:
        "200":
          description: List of posts
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PostList"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "429":
          $ref: "#/components/responses/RateLimited"

  /v1/posts/{postId}:
    parameters:
      - $ref: "#/components/parameters/postId"

    get:
      tags: [Posts]
      summary: Get a post
      operationId: getPost
      security:
        - apiKeyAuth: []
      responses:
        "200":
          description: Post details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Post"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "429":
          $ref: "#/components/responses/RateLimited"

    patch:
      tags: [Posts]
      summary: Update a post
      description: Only `content` is mutable. Status changes use action endpoints.
      operationId: updatePost
      security:
        - apiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdatePostRequest"
      responses:
        "200":
          description: Post updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Post"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "429":
          $ref: "#/components/responses/RateLimited"

  /v1/posts/{postId}/schedule:
    parameters:
      - $ref: "#/components/parameters/postId"

    post:
      tags: [Posts]
      summary: Schedule a post
      description: |
        Schedules a draft post for future publishing.
        Only posts with status `draft` can be scheduled.
      operationId: schedulePost
      security:
        - apiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SchedulePostRequest"
      responses:
        "200":
          description: Post scheduled
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Post"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"
        "429":
          $ref: "#/components/responses/RateLimited"

  /v1/posts/{postId}/analytics:
    parameters:
      - $ref: "#/components/parameters/postId"

    get:
      tags: [Posts]
      summary: Get post analytics
      description: Returns engagement metrics for a post. Only available for published posts.
      operationId: getPostAnalytics
      security:
        - apiKeyAuth: []
      responses:
        "200":
          description: Analytics data
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PostAnalytics"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "429":
          $ref: "#/components/responses/RateLimited"

components:
  securitySchemes:
    sessionAuth:
      type: http
      scheme: bearer
      description: Session token (pub_session_*) for account management

    apiKeyAuth:
      type: http
      scheme: bearer
      description: API key (pub_live_* or pub_test_*) for API access

  parameters:
    appId:
      name: appId
      in: path
      required: true
      schema:
        type: string
        format: uuid

    keyId:
      name: keyId
      in: path
      required: true
      schema:
        type: string
        format: uuid

    postId:
      name: postId
      in: path
      required: true
      schema:
        type: string
        format: uuid

    idempotencyKey:
      name: Idempotency-Key
      in: header
      description: Unique key to ensure idempotent requests
      schema:
        type: string

  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error:
              code: INVALID_REQUEST
              message: content is required
              request_id: req_abc123

    Unauthorized:
      description: Missing or invalid authentication
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error:
              code: UNAUTHORIZED
              message: Invalid API key
              request_id: req_abc123

    Forbidden:
      description: Insufficient permissions
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error:
              code: FORBIDDEN
              message: "Insufficient permissions. Required scope: posts:write"
              request_id: req_abc123

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error:
              code: NOT_FOUND
              message: Post not found
              request_id: req_abc123

    Conflict:
      description: Request conflicts with current state
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error:
              code: CONFLICT
              message: Cannot schedule post with status 'scheduled'
              request_id: req_abc123

    RateLimited:
      description: Too many requests
      headers:
        X-RateLimit-Limit:
          schema:
            type: integer
        X-RateLimit-Remaining:
          schema:
            type: integer
        Retry-After:
          schema:
            type: integer
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error:
              code: RATE_LIMIT_EXCEEDED
              message: Too many requests. Please retry later.
              request_id: req_abc123

  schemas:
    Error:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
              enum:
                - UNAUTHORIZED
                - FORBIDDEN
                - INVALID_REQUEST
                - NOT_FOUND
                - CONFLICT
                - RATE_LIMIT_EXCEEDED
                - INTERNAL_ERROR
            message:
              type: string
            request_id:
              type: string
          required: [code, message, request_id]

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded]
        checks:
          type: object
          properties:
            database:
              type: string
              enum: [healthy, unhealthy]
            cache:
              type: string
              enum: [healthy, unhealthy]
        timestamp:
          type: string
          format: date-time

    RegisterRequest:
      type: object
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8
        name:
          type: string
      required: [email, password]

    LoginRequest:
      type: object
      properties:
        email:
          type: string
          format: email
        password:
          type: string
      required: [email, password]

    LoginResponse:
      type: object
      properties:
        token:
          type: string
          description: Session token (shown only once)
          example: pub_session_abc123...
        expires_at:
          type: string
          format: date-time
        user:
          $ref: "#/components/schemas/UserSummary"

    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        email_verified:
          type: boolean
          description: Whether the email address has been verified
        email_verified_at:
          type: string
          format: date-time
          nullable: true
          description: Timestamp when email was verified
        name:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    UserSummary:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
        name:
          type: string
          nullable: true

    CreateAppRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 2
          maxLength: 100
        description:
          type: string
        environment:
          type: string
          enum: [development, production]
          default: development
      required: [name]

    UpdateAppRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 2
          maxLength: 100
        description:
          type: string

    App:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
          nullable: true
        environment:
          type: string
          enum: [development, production]
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateApiKeyRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 2
        scopes:
          type: array
          items:
            type: string
            enum: [posts:read, posts:write, analytics:read]
          minItems: 1
      required: [name, scopes]

    ApiKeyCreated:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        key:
          type: string
          description: The full API key (shown only once!)
          example: pub_test_abc123...
        key_prefix:
          type: string
          example: pub_test_abc123
        scopes:
          type: array
          items:
            type: string
        expires_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        _warning:
          type: string
          example: Store this key securely. It will not be shown again.

    ApiKey:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        key_preview:
          type: string
          description: Masked key prefix
          example: pub_test_abc123...
        scopes:
          type: array
          items:
            type: string
        last_used_at:
          type: string
          format: date-time
          nullable: true
        expires_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time

    CreatePostRequest:
      type: object
      properties:
        content:
          type: string
        scheduled_at:
          type: string
          format: date-time
          description: Must be in the future
      required: [content]

    UpdatePostRequest:
      type: object
      properties:
        content:
          type: string
          minLength: 1
      required: [content]

    SchedulePostRequest:
      type: object
      properties:
        scheduled_at:
          type: string
          format: date-time
          description: Must be in the future
      required: [scheduled_at]

    Post:
      type: object
      properties:
        id:
          type: string
          format: uuid
        status:
          type: string
          enum: [draft, scheduled, published, failed]
        content:
          type: string
        scheduled_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    PostList:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/Post"
        pagination:
          type: object
          properties:
            limit:
              type: integer
            next_cursor:
              type: string
              format: date-time
              nullable: true
            has_next_page:
              type: boolean

    PostAnalytics:
      type: object
      properties:
        post_id:
          type: string
          format: uuid
        status:
          type: string
        impressions:
          type: integer
          nullable: true
        engagements:
          type: integer
          nullable: true
        engagement_rate:
          type: number
          nullable: true
        message:
          type: string
          description: Present when analytics not available
        _meta:
          type: object
          properties:
            source:
              type: string
              example: mocked
            generated_at:
              type: string
              format: date-time
